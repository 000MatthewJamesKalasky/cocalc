<!doctype html>
<html>
<head>
<script type="text/javascript" src="static/jquery/jquery.min.js"></script>
<script type="text/javascript" src="static/socketio/socket.io.js"></script>

<link rel="stylesheet" href="static/codemirror/codemirror.css">
<script type="text/javascript" src="static/codemirror/codemirror.js"></script>
<script type="text/javascript" src="static/codemirror/mode/python.js"></script>
<style type="text/css">

      .CodeMirror {
        border: 1px solid #99f; 
/*        background-color: #fffff0;  */
      }
      .CodeMirror-scroll {
        height: auto; 
        overflow-y: hidden;
        overflow-x: auto;
      width: 100%;
      }

      .stderr {
        color:#880000;
        background-color:orange;
        font-weight:bold;
      }


      .output {
/*          font-family:"Courier New"; 
          font-size:12pt;
        border:2px solid #9f9; padding:1px; */
      }

      .wrap {  /* see http://www.longren.org/wrapping-text-inside-pre-tags/ */
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
       }
</style>

<script type="text/javascript" src="static/backend.js"></script>
<script type="text/javascript">

$(function() {

    $('body').keydown(function(event) { 
	if (event.which == 13 && event.shiftKey) {
	    execute_code_cell('#cell-0');
	    return false;
	} else if (event.which == 67 && event.ctrlKey) {
	    sigint();
	    return false;
	}
    });


    function walltime() { return (new Date()).getTime(); }

    // TODO: vargs
    function call_ifdef(selector, name, a1, a2) {
        var obj = $(selector);
        var f = obj.data(name);
        if (typeof f === 'undefined') return;
        if (typeof a2 === 'undefined') { f(a1); return; }
        if (typeof a1 === 'undefined') { f(); return; }
        f(a1,a2);
    }

    var options = {
	set:function(selector, value) { call_ifdef(selector, 'set', value); },
        mesg:function(selector, value) { call_ifdef(selector, 'mesg', value); },
 	stdout:function(selector, value, clear) { call_ifdef(selector, 'stdout', value, clear); },
	stderr:function(selector, value, clear) { call_ifdef(selector, 'stderr', value, clear); },
        start:function(selector) { call_ifdef(selector, 'start'); },
	done:function(selector) { call_ifdef(selector, 'done'); }
    }

    var socket = sagews_backend.socket('http://' + window.location.host, options);

    function preparse(input) {
        return "exec preparse(r'''"+input+"''') in globals()";
    }

    function execute_code_cell(selector) { 
	var input = cm_input.getValue();
	socket.set(selector, input);  // set input of other clients
        if ($('#preparse').is(':checked')) { input = preparse(input); }
	socket.execute(selector, input);
        update_status();
    }

    function update_status() {
        socket.execute('#status', 
        'print("Memory: %sMB    Variables: %s"%(int(sage.all.get_memory_usage()), ", ".join(sage.all.show_identifiers())))');
    }

    var start_time = walltime();
    update_status();

    var cm_input = CodeMirror.fromTextArea($("#input-0")[0], 
                      {lineNumbers: true, indentUnit: 4, matchBrackets:true});

    var cm_stdout = CodeMirror.fromTextArea($("#stdout-0")[0], 
         {lineNumbers: false, lineWrapping:true});
    var cm_stderr = CodeMirror.fromTextArea($("#stderr-0")[0], 
         {lineNumbers: false, lineWrapping:true});


    $('#execute-0').click(function() { execute_code_cell('#cell-0') });

    $('#cell-0').data('set', 
        function(value) { cm_input.setValue(value); }
    ).data('start',
        function () {
            $('#cell-0').data('start_time', walltime());
        }
    ).data('mesg',
        function (value) {
            if (value.type === 'alert') {
                alert(value.value);
            } 
        }
    ).data('stdout', 
	function(value, clear) {
            if (clear) {
                cm_stdout.setValue(value);
            } else {
                cm_stdout.setValue(cm_stdout.getValue() + value);  // TODO
            }
	}
    ).data('stderr', 
	function(value, clear) {
            if (clear) {
                cm_stderr.setValue(value);
            } else {
                cm_stderr.setValue(cm_stderr.getValue() + value);  // TODO
            }
	}
    ).data('done',
        function () { 
	    var s = 'last time: ' + (walltime() - $('#cell-0').data('start_time')) + ' ms';
	    $('#time')[0].innerHTML = s;
	}
   );

   $('#status').css({'borderWidth':'2px', 'borderStyle':'solid', 'borderColor':'grey',
                     'padding':'5px', height:'1em'})
	.data('stdout', function(value, clear) { $('#status')[0].innerHTML = value; })
	.data('stderr', function(value, clear) {})
	.data('done', function() {})
	.data('set', function(value) {});

})

</script>


<body>

<pre><div id="status">status line</div></pre>
<span id="time">last time:</span>
<br>
<input id="preparse" type="checkbox" checked="true" /> preparse
<button id="execute-0">Execute (shift+enter)</button>
<hr>
<br><br>

<div id="cell-0">
<textarea id="input-0">
for i in [1..10]: 
    print chr(randint(40,100))*(8*i)</textarea>
<textarea id="stdout-0" class="stdout"></textarea>
<textarea id="stderr-0"></textarea>
</div>


</body>
</html>
