<!doctype html>
<html>
<head>

<!-- jquery -->
<script type="text/javascript" src="static/jquery/jquery.min.js"></script>

<!-- jquery-ui -->
<script type="text/javascript" src="static/jquery-ui/js/jquery-ui.min.js"></script>
<link rel="stylesheet" href="static/jquery-ui/css/pepper-grinder/jquery-ui.css">
<!--<link rel="stylesheet" href="static/jquery-ui/css/smoothness/jquery-ui.css"> -->

<!-- socket.io -->
<script type="text/javascript" src="static/socketio/socket.io.js"></script>

<!-- codemirror -->
<link rel="stylesheet" href="static/codemirror/codemirror.css">
<script type="text/javascript" src="static/codemirror/codemirror.js"></script>
<script type="text/javascript" src="static/codemirror/mode/python.js"></script>



<style type="text/css">
      body {
        margin:0;
        padding:0;
        height:200;
      }

      .CodeMirror-scroll {
        height: auto; 
/*        width: 100%; */
      }

      .CodeMirror {
        border: 1px solid #eee;
        overflow-x: auto;
        overflow-y: auto; 
        background-color: #ffffff;    
      }

      .CodeMirror-focused {
	  border: 1px solid #99f; 
          background-color: #fffff0;    
          max-height:100em;
      }

      .CodeMirror-gutter  {
          z-index:0;
      }

      .sagews-stdin {

      }

      .sagews-stdin-scroll {
	max-height:10em;
      }

      .sagews-stderr {
        background-color:#faa;
        font-weight:bold;
        max-height:10em;
      }

      .sagews-stdout {
        background-color:#fafafa;
	max-height:10em; 
      }

      .sagews-cells {
	  height:15em;
	  overflow:auto;
	  padding:1;
	  border: 3px solid #000;
      }

      .sagews-cmdline {
          height:15em;
	  overflow:auto;
	  width:100%;
      }

      /* make buttons smaller*/
      .ui-button.ui-widget .ui-button-text{ line-height:1em; font-size:small }

      .wrap {  /* see http://www.longren.org/wrapping-text-inside-pre-tags/ */
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
       }

      .sagews-status {
        background-color:#faa;
	height:15em;
	font-size:small;
      } 

</style>

<script type="text/javascript" src="static/backend.js"></script>
<script type="text/javascript">

function walltime() { return (new Date()).getTime(); }

$(function() {

/*    $('body').keydown(function(event) { 
	if (event.which == 13 && event.shiftKey) {
	    execute_code_cell('#cell-0');
	    return false;
	} else if (event.which == 67 && event.ctrlKey) {
	    sigint();
	    return false;
	}
    });
*/
    
    var completions = $('#completions');
    completions.css({position:'absolute', 'z-index':2}
    ).hide(
    ).keyup(function(e) {
	if (e.keyCode === 27) { console.log('esc'); completions.data('finish')(''); }  /* esc */
	if (e.keyCode == 8) { return false;}
	/*if (e.keyCode == 8 && !completions[0].value) { completions.data('finish')(); } *//* backspace */
    }).keydown(function(e) {
	if (e.keyCode === 13) {
	    completions.data('finish')(completions[0].value);  
	    return false;
	}
	if (e.keyCode == 9) { /* tab */
	    return false;
	}
    }).autocomplete({
	close:function (event, ui) { 
	    completions.data('finish')();
	}
    });

    $('#completions_error').hide().dialog({
          autoOpen:false, show:'slide', hide:'slide', minWidth:450});

    $('#help_window').hide().dialog({
          autoOpen:false, show:'slide', hide:'slide', minWidth:600});

    // TODO: vargs
    function call_ifdef(selector, name, a1, a2) {
        var obj = $(selector);
        var f = obj.data(name);
        if (typeof f === 'undefined') return;
        if (typeof a2 === 'undefined') { f(a1); return; }
        if (typeof a1 === 'undefined') { f(); return; }
        f(a1,a2);
    }

    var options = {
	set:function(selector, value) { call_ifdef(selector, 'set', value); },
        mesg:function(selector, value) { call_ifdef(selector, 'mesg', value); },
 	stdout:function(selector, value, clear) { call_ifdef(selector, 'stdout', value, clear); },
	stderr:function(selector, value, clear) { call_ifdef(selector, 'stderr', value, clear); },
        start:function(selector) { call_ifdef(selector, 'start'); },
	done:function(selector) { call_ifdef(selector, 'done'); }
    }

    var socket = sagews_backend.socket('http://' + window.location.host, options);

    function update_status() {	
	var cmd = 'print("Memory: %sMB\\n\\nVariables: %s\\n\\n\\n\\n"%(int(sage.all.get_memory_usage()), ", ".join(sorted(sage.all.show_identifiers()))))';
	socket.execute_blocking(cmd,
		function (mesg) { $('#status').html(mesg.stdout); });
    }

    var start_time = walltime();
    update_status();

   $('#status').css({'borderWidth':'2px', 'borderStyle':'solid', 'borderColor':'grey',
                     'padding':'5px'})

    function trim_cm(cm) {
	var val = cm.getValue();
	if (val[val.length-1] === '\n') {
	    cm.setValue(val.slice(0,val.length-1));
	}
    }

    function SageCell(id, options) {

	var opts = $.extend({
	    stdin:'', 
	    stdout:'', 
	    stderr:'', 
	    html:'',
	    max_output:100000,
	}, options||{});

	function get_completions(code, cursor, callback) {
	    /* TODO: escape better and jsonify output maybe */
	    var cmd = 'print _completions(' + cursor.ch + ',' + cursor.line + ', jsonify=True)';
	    socket.execute_blocking(cmd, function (mesg) {
		if (mesg.stderr !== '') {
		    console.log(mesg.stderr); /* TODO: for debugging only */
		    callback([], '', 'error');
		    return;
		} 
		var r = $.parseJSON(mesg.stdout);
		if (r.help) {
		    /* TODO: implement real help viewer with html, etc. -- this is a silly quick hack*/
		    $('#help_window').dialog({'title':'Help on '+r.expr.slice(0,r.expr.length-1)}).html('<font size=-3><textarea readonly="readonly" cols=80 rows=16>'+r.result+'</textarea></font>').dialog( {close : function() { stdin.focus(); }}).dialog('open');
		    return;
		}
		callback(r.result, r.target, 'ok');
		update_status();  /* since completion can cause side effects */
	    },  true, code)
	}

	function completion(cm) {     
	    var cursor = stdin.getCursor();
	    var code = stdin.getValue();
	    var target = code;  /* callback if it happens changes this later */
	    var this_line = stdin.getLine(cursor.line).slice(0,cursor.ch)

	    if (this_line.length == 0 || this_line[this_line.length-1].replace(/\s/g,"") === "") {
		stdin.replaceRange('    ', cursor);		
		return;
	    }

	    var pos = stdin.cursorCoords();
	    var c = $('#completions');

	    function finish(val) {
		if (typeof val === "undefined") { val = "";}
		if (!c.is(':visible')) { stdin.focus(); return; }
		c.hide();
		stdin.focus();
		if (val.length > 0) {
		    stdin.replaceRange(val, {line:cursor.line, ch:cursor.ch-target.length}, cursor);
		}
	    }
	    c.data('finish', finish);

	    get_completions(code, cursor, function (source, target0, status) {
		target = target0;
		if (status != 'ok') {
		    $('#completions_error').dialog( {close : function() { stdin.focus(); }}
                    ).dialog('open');
		    return;
		}
		if (source.length === 0) {
		    stdin.replaceRange('    ', cursor);
		    return;
		}
		if (source.length === 1) {
		    stdin.replaceRange(source[0].slice(target.length), cursor);
		    return;
		}
		c.show().focus().css({top:pos.y, left:pos.x}).val(target).autocomplete({
		    autoFocus:false,
		    minLength:0,
		    source:source,
		    select:function(event, ui) { 
			finish(ui.item.value);
		    }
		}).autocomplete("search");
	    })
	}

        var cell = $('<div id="' + id + '" class="sagews-cell"></div>')[0];
        var stdin = CodeMirror(cell, {
	                 value:opts.stdin,
                         lineNumbers: false, 
                         indentUnit: 4, 
                         matchBrackets:true,
                         lineWrapping:true, 
	                 autoClearEmptyLines: true,
                         gutter: true,
                         extraKeys:{
			     'Enter': function(cm) { execute(); },
			     'Shift-Enter': function(cm) { cm.replaceRange('\n',stdin.getCursor()); },
			     'Up':function(cm) { up(); },
			     'Down':function(cm) { down(); },
			     'Tab':completion,
			 }
                    });

	$(stdin.getWrapperElement()).addClass('sagews-stdin'); 
        $(stdin.getScrollerElement()).addClass('sagews-stdin-scroll');

/*        stdin.setMarker(0, 'sage: '); */

        var stdout = CodeMirror(cell, {
	    value:opts.stdout, lineWrapping:true, readOnly:true})
	var stderr = CodeMirror(cell, {
	    value:opts.stderr, lineWrapping:true, readOnly:true});
	var html = $('<div></div>').append(html)[0];

	// Stylize stdout and stderr
	var stdout_elt = $(stdout.getWrapperElement());
	var stderr_elt = $(stderr.getWrapperElement());
	if (opts.stdout === '') { stdout_elt.hide(); }
	if (opts.stderr === '') { stderr_elt.hide(); } 
	stdout_elt.addClass('sagews-stdout');
	stderr_elt.addClass('sagews-stderr');

	var wcell = $(cell);
        wcell.data({'streams':{'stdin':stdin, 'stdout':stdout, 'stderr':stderr},
                    'focus':function(line, ch) { 
	               stdin.focus(); 
                       if (typeof line === "undefined") { return; }
	               if (line<0) { line += stdin.lineCount(); }
	               stdin.setCursor(line, ch); 
		       opera_focus_hack();
	            },
                    'refresh':function() { stdin.refresh(); stdout.refresh(); stderr.refresh(); },
		    'set':    function(value) { stdin.setValue(value); },
		    'start':  function() { 
			stderr_elt.hide();
			wcell.data('start_time', walltime()); 
		    },
		    'mesg':   function(value) { 
			if (value.type === 'javascript') {eval(value.value);}
		    },
		    'stdout': function(value, clear) {
			if (clear) {
			    if (value) { stdout_elt.show(); }
			    stdout.setValue(truncate(value));
			} else {
			    stdout.setValue(truncate(stdout.getValue() + value));  // TODO
			}
		    },
		    'stderr': function(value, clear) {
			if (clear) {
			    if (value) { stderr_elt.show(); }
			    stderr.setValue(truncate(value));
			} else {
			    stderr.setValue(truncate(stderr.getValue() + value));  // TODO
			}
		    },
		    'done':   function () { 
			var s = (walltime() - wcell.data('start_time')) + ' ms';
			$('#time')[0].innerHTML = s;
			trim_cm(stdout); trim_cm(stderr);
			if (stdout.getValue() === '') { stdout_elt.hide(); }
			if (stderr.getValue() === '') { stderr_elt.hide(); } 
			update_status();
		    }
		   });

	function truncate(s) {
	    if (s.length < opts.max_output) {
		return s;
	    } else {
		/* TODO: at this point, should maybe send interrupt or at least cancel output being sent -- maybe this should be entirely backend side*/
		return s.slice(0, opts.max_output) + ' (output truncated) ';
	    }
	}

	function opera_blur_hack() {
	    /* This is a hack needed for Opera -- at least v 11.64 on OS X. 
	       It's copied from codemirror.js's onBlur() function. */
	    var wrapper = $(stdin.getWrapperElement())[0];
	    wrapper.className = wrapper.className.replace(" CodeMirror-focused", ""); 
	}

	function opera_focus_hack() {
	    /* This is a hack needed for Opera -- at least v 11.64 on OS X. 
	       It's copied from codemirror.js's onBlur() function. */
	    var wrapper = $(stdin.getWrapperElement())[0];
            if (wrapper.className.search(/\bCodeMirror-focused\b/) == -1) {
		wrapper.className += " CodeMirror-focused";
	    }
	}

	function execute() { 
	    opera_blur_hack();
	    var val = stdin.getValue();
	    socket.set('#'+id, val);
	    socket.execute('#'+id, val, true); 
	    var next = wcell.next();
	     if (next.length === 0) { 
		 /* TODO: this feals hacked, maybe.  It's so we can have many command lines at once */
		 var cells_id = wcell.parent().attr('id');
		 next = $(appendSageCell('#'+cells_id));
	     }
	    next.data('focus')(0,0);
	}
	
	function up() {
	    var coords = stdin.getCursor();
	    if (coords.line >= 1) {
		stdin.setCursor(coords.line - 1, coords.ch);
	    } else {
		var f = wcell.prev().data('focus'); 
		if (typeof f !== 'undefined') { 
		    opera_blur_hack();
		    f(-1, coords.ch); 
		} 
	    }
	}

        function down() {
	    var coords = stdin.getCursor();
	    if (coords.line < stdin.lineCount() - 1) {
		stdin.setCursor(coords.line + 1, coords.ch);
	    } else {
		var f = wcell.next().data('focus')
		if (typeof f !== 'undefined') { 
		    opera_blur_hack();
		    f(0, coords.ch);  
		} 
	    }
        }
	return cell;
    }

    var cell_number = -1;
    function next_cell_number() {
	cell_number += 1;
	return cell_number;
    }
    function appendSageCell(selector, options) {
	var id = 'cell-' + next_cell_number();
	if ($('#'+id).length != 0) {
	    alert("trying to create a cell with the id " + id + " that already exists will cause horrible confusion!");
	}
	var cell = SageCell(id, options);	
	$(selector).append(cell);
	$(cell).data('refresh')(); 
	return cell;
    }

    /* Create the first Sage cell */
    
    $(appendSageCell('#cells-0')).data('focus')();

/*    $('#cells-1').sortable({ opacity:0.8, delay:1000});  
*/

    function session_name() {
	return $('#session-name').val();
    }
    $('#save-session').click(
	function() { 
	    socket.execute('#save-session','save_session("' + session_name() + '")'); 
	}).data('done', function () { /* TODO: visual feedback */ })

    $('#load-session').click(
	function() { 
	    socket.execute('#load-session','reset(); load_session("' + session_name() + '")'); 
	}).data('done', function () { /* TODO: visual feedback */  update_status(); })

    $('#reset-session').click(
	function() { 
	    socket.execute('#reset-session','reset()'); 
	}).data('done', function () { /* TODO: visual feedback */ update_status(); })

    $("#tabs").tabs({ 
	show : function(event, ui) {
	    $(this).data('tabs-current-index',ui.index);
	    var f = $(ui.panel).children(':last-child').data('focus')
	    if (typeof f === 'undefined') return;
	    f(); 
	    $(ui.panel).scrollTop(10000);
	}
     }).tabs('select', 0); /* .resizable(); */

/* The following works, but confuses other code for renaming etc that uses index. */
/*    $('#tabs').find( ".ui-tabs-nav" ).sortable({'axis':'x'}).css({'fontSize':'small'});

*/

    $('#tabs').data({
	'set-tab-label':function(index, label) {
	    $($('#tabs ul li a')[index]).html(label);  
	}
    });

    $('#tabs').append($('#status')).tabs('add','#status', 'status');

    $('#button-bar').sortable({axis:'x'});

    $('#add-cmdline-button').button().click(
	function (event,ui) { 
	    var n = $('#tabs').tabs('length');
	    $('#tabs').append(newCommandLine('cells-'+n, n));
	    appendSageCell('#cells-'+n);
	    $('#tabs').tabs("add", '#cells-'+n, n).tabs('select', n)
	}
    ).click();

    $('#prev-button').button().click( function(event,ui) {
	var t = $('#tabs');
	var index = t.data('tabs-current-index') - 1;
	if (index < 0) {
	    index = t.tabs('length')-1;
	}
	console.log(index);
	t.tabs('select', index);
    })
    $('#next-button').button().click( function(event,ui) {
	var t = $('#tabs');
	var index = t.data('tabs-current-index') + 1;
	if (index >= t.tabs('length')) {
	    index = 0;
	}
	console.log(index);
	t.tabs('select', index);
    })

    $('#add-editor-button').button();

    $('#newline-button').button();
    $('#submit-button').button();
    $('#complete-button').button();

    $('#rename-dialog').dialog({
	autoOpen:false,
	modal:true,
	show: { effect: 'drop', direction: "up", duration:100},
	hide: { effect: 'drop', direction: "down", duration:100},
	buttons:{
	    Ok: function() { $(this).dialog("close").data('sagews-rename')() }
	}
    }).keypress(function(e) { if (e.which===13) { $(this).dialog('close').data('sagews-rename')() }});

    $('#rename-button').button().click(function(event,ui) {
	var t = $('#tabs');
	var index = t.data('tabs-current-index');
	var d = $('#rename-dialog');
	var title = t.find('ul li a')[index].text;
	d.children('input').val(title);
	d.data('sagews-rename', function () {
	    t.data('set-tab-label')(index, d.children('input').val());
	    /* ensure that it gets selected so gets focus back.*/
	});

	d.dialog("open").dialog({'close':function(event,ui){
	    if(index>0) {
		t.tabs('select', index-1);
	    } else {
		t.tabs('select', index+1);
	    }
	    t.tabs('select', index);
	}});
    });
				      

    function newCommandLine(id, label) {
	var c = $('#sagews-cell-template').clone().show().attr('id', id);
	return c;
    }

    $('#sagews-cell-template').hide(); 

    $('body').scrollTop(0);

})</script>


<body>
<div id="status" class="wrap sagews-status">status</div>
Session: <input id="session-name" value="sagews"> <button id="save-session">save</button><button id="load-session">load</button><button id="reset-session">reset</button>
&nbsp;&nbsp;&nbsp;&nbsp;
Last Time: <span id="time">0 ms</span>
<br>
<!--<input id="preparse" type="checkbox" checked="true" /> preparse
<button id="execute-0">Execute (shift+enter)</button>
-->
<hr>

<input id="completions" size=60>
<div id="completions_error" title="Completions"></div>
<div id="help_window" title="Help"></div>



<div id="button-bar">
<span><button id="prev-button"><</button> </span>
<span><button id="next-button">></button> </span>
<span><button id="add-cmdline-button">+ Commands</button> </span>
<span><button id="add-editor-button">+ Editor</button> </span>
<span><button id="newline-button">Newline</button> </span>
<span><button id="submit-button">Execute</button> </span>
<span><button id="complete-button">Complete</button> </span>
<span><button id="rename-button">Rename</button> </span>
</div>

<div id="tabs"><ul></ul></div>

<div id="sagews-cell-template" class="sagews-cells"></div>

<div id="rename-dialog" title="Rename">
<input type="text" value="new name">
</div>


</body>
</html>



<!--

for i in range(1000):
    sleep(.005)
    sagews.javascript('$("#status").css({"borderWidth":"%spx"})'%(20*float(sin(.1*i))))

-->
