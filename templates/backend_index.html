<!doctype html>
<html>
<head>
<script type="text/javascript" src="static/jquery/jquery.min.js"></script>
<script type="text/javascript" src="static/socketio/socket.io.js"></script>

<link rel="stylesheet" href="static/codemirror/codemirror.css">
<script type="text/javascript" src="static/codemirror/codemirror.js"></script>
<script type="text/javascript" src="static/codemirror/mode/python.js"></script>
<style type="text/css">
      .CodeMirror {
/*        border: 2px solid #99f; */
/*        background-color: #fffffa; */
      }
      .CodeMirror-scroll {
        height: auto;
        overflow-y: hidden;
        overflow-x: auto;
        width: 100%;
      }

      .stderr {
        color:#880000;
        background-color:orange;
        font-weight:bold;
      }

      .cell {
          border:2px solid #aaa; padding:5px; 
      }

      .output {
/*          font-family:"Courier New"; 
          font-size:12pt;
        border:2px solid #9f9; padding:1px; */
      }

      .wrap {  /* see http://www.longren.org/wrapping-text-inside-pre-tags/ */
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
       }
</style>

<script type="text/javascript" src="static/backend.js"></script>
<script type="text/javascript">

$(function() {


    $('body').keydown(function(event) { 
	if (event.which == 13 && event.shiftKey) {
	    execute_code_cell('#cell-0');
	    return false;
	} else if (event.which == 67 && event.ctrlKey) {
	    sigint();
	    return false;
	}
    });


    function walltime() { return (new Date()).getTime(); }

    var options = {
	set:function(selector, value) {
	    var obj = $(selector);
            var f = obj.data('set')
	    if (f === 'undefined') { 
		obj[0].innerHTML = value; 
	    } else { 
try {
		f(value); 
} catch(e) { }
	    }
	},

 	stdout:function(selector, value, clear) {
try {
	    $(selector).data('stdout')(value, clear);
} catch(e) {}
        },

	stderr:function(selector, value, clear) {
try {
	    $(selector).data('stderr')(value, clear);
} catch(e) {}
        },

        start:function(selector) {
try {
	    $(selector).data('start')();
} catch(e) {}
        },

	done:function(selector) {
try {
	    $(selector).data('done')();
} catch(e) {}
        }
    }

    var socket = sagews_backend.socket('http://' + window.location.host, options);

    function preparse(input) {
        return "from sage.misc.preparser import preparse\nexec preparse('''"+input+"''') in globals()";
    }

    function execute_code_cell(selector) { 
	var input = cm_input.getValue();
	socket.set(selector, input);  // set input of other clients
        if ($('#preparse').is(':checked')) { input = preparse(input); }
	socket.execute(selector, input);
        update_status();
    }

    function update_status() {
        socket.execute('#status', 
        'print("Memory: %sMB    Variables: %s"%(int(sage.all.get_memory_usage()), ", ".join(sage.all.show_identifiers())))');
    }

    var start_time = walltime();
    update_status();

    var cm_input = CodeMirror.fromTextArea($("#input-0")[0], 
                      {lineNumbers: true, indentUnit: 4, matchBrackets:true});

    $('#execute-0').click(function() { execute_code_cell('#cell-0') });

    $('#cell-0').data('set', 
        function(value) { cm_input.setValue(value); }
    ).data('start',
        function () {
            $('#cell-0').data('start_time', walltime());
        }
    ).data('stdout', 
	function(value, clear) {
            var obj = $('#output-0')[0];
            if (clear) {
                obj.innerHTML = value;
            } else {
    	        obj.innerHTML += value;
            }
	}
    ).data('stderr', 
	function(value, clear) {
            value = '<span class="stderr">' + value + '</span>';
            var obj = $('#output-0')[0];
            if (clear) {
                obj.innerHTML = value;
            } else {
    	        obj.innerHTML += value;
            }
	}
    ).data('done',
        function () { 
	    var s = 'last time: ' + (walltime() - $('#cell-0').data('start_time')) + ' ms';
	    $('#time')[0].innerHTML = s;
	}
   );

   $('#status').css({'borderWidth':'2px', 'borderStyle':'solid', 'borderColor':'grey',
                     'padding':'5px', height:'1em'})
	.data('stdout', function(value, clear) { $('#status')[0].innerHTML = value; })
	.data('stderr', function(value, clear) {})
	.data('done', function() {})
	.data('set', function(value) {});

})

</script>


<body>

<pre><div id="status">status line</div></pre>
<span id="time">last time:</span>
<br>
<input id="preparse" type="checkbox" checked="true" /> preparse
<button id="execute-0">Execute (shift+enter)</button>
<hr>
<br><br>
<div id="cell-0" class="cell">
<textarea id="input-0">
for i in [1..10]: 
    print chr(randint(40,100))*(8*i)</textarea>
<pre id="output-0" class="output wrap"></pre>
</div>


</body>
</html>
