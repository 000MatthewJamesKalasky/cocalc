<!doctype html>
<html>
<head>
<script type="text/javascript" src="static/jquery/jquery.min.js"></script>
<script type="text/javascript" src="static/socketio/socket.io.js"></script>

<link rel="stylesheet" href="static/codemirror/codemirror.css">
<script type="text/javascript" src="static/codemirror/codemirror.js"></script>
<script type="text/javascript" src="static/codemirror/mode/python.js"></script>
<style type="text/css">
      .CodeMirror {
        border: 2px solid #99f;
        background-color: #fffff0;
      }
      .CodeMirror-scroll {
        height: auto;
        overflow-y: hidden;
        overflow-x: auto;
        width: 100%;
      }

      .stderr {
        color:#880000;
        background-color:orange;
        font-weight:bold;
      }

      .output {
/*        font-family:"Courier New"; */
        border:2px solid #9f9; padding:1px;
      }

      .wrap {  /* see http://www.longren.org/wrapping-text-inside-pre-tags/ */
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
       }
</style>

<script type="text/javascript" src="static/backend.js"></script>
<script type="text/javascript">

$(function() {


    $('body').keydown(function(event) { 
	if (event.which == 13 && event.shiftKey) {
	    execute_code_cell(0);
	    return false;
	} else if (event.which == 67 && event.ctrlKey) {
	    sigint();
	    return false;
	}
    });

    $('#status').css({'borderWidth':'2px', 'borderStyle':'solid', 'borderColor':'grey',
                      'padding':'5px', height:'1em'});

    function walltime() { return (new Date()).getTime(); }

    var options = {
	set:function(selector, value) {
            $(selector).data('set')(value);
	},

 	stdout:function(selector, value, clear) {
            var obj = $(selector)[0];
            if (clear) {
                obj.innerHTML = value;
            } else {
    	        obj.innerHTML += value;
            }
        },

	stderr:function(selector, value, clear) {
            value = '<span class="stderr">' + value + '</span>';
            var obj = $(selector)[0];
            if (clear) {
                obj.innerHTML = value;
            } else {
    	        obj.innerHTML += value;
            }
        },

	done:function(selector) {
	    $('#time')[0].innerHTML = 'last time: ' + (walltime() - start_time) + ' ms';
        }
    }

    var socket = sagews_backend.socket('http://' + window.location.host, options);

    function preparse(input) {
        return "from sage.misc.preparser import preparse\nexec preparse('''"+input+"''') in globals()";
    }

    function execute_code_cell(id) { 
        start_time = walltime();
	var input = cm_input.getValue();
	socket.execute('#output-'+id, $('#preparse').is(':checked') ? preparse(input) : input);
        /* start code executing */ 
        /* set input if there are other clients (otherwise does nothing) */
	socket.set('#input-'+id, input); 
        update_status();
    }

    function update_status() {
        socket.execute('#status', 
        'print("Memory: %sMB    Variables: %s"%(int(sage.all.get_memory_usage()), ", ".join(sage.all.show_identifiers())))');
    }

    var start_time = walltime();
    update_status();

    var cm_input = CodeMirror.fromTextArea($("#input-0")[0], { 
        lineNumbers: true, indentUnit: 4, matchBrackets:true
    });
    $('#execute-0').click(function() { execute_code_cell(0) });

    $('#input-0').data('set', function(s) { cm_input.setValue(s); });
    $('#status').data('set', function(s) {});

});

</script>


<body>

<pre><div id="status">status line</div></pre>
<span id="time">last time:</span>
<br>
<input id="preparse" type="checkbox" checked="true" /> preparse
<hr>


<button id="execute-0">Execute (shift+enter)</button>
<textarea id="input-0">
for i in [1..10]: 
    print i, chr(randint(65,97))*(8*i)</textarea>
<pre id="output-0" class="output wrap"></pre>


</body>
</html>
