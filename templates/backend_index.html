<!doctype html>
<html>
<head>

<!-- jquery -->
<script type="text/javascript" src="static/jquery/jquery.min.js"></script>

<!-- jquery-ui -->
<script type="text/javascript" src="static/jquery-ui/js/jquery-ui.min.js"></script>
<link rel="stylesheet" href="static/jquery-ui/css/pepper-grinder/jquery-ui.css">

<!-- socket.io -->
<script type="text/javascript" src="static/socketio/socket.io.js"></script>

<!-- codemirror -->
<link rel="stylesheet" href="static/codemirror/codemirror.css">
<script type="text/javascript" src="static/codemirror/codemirror.js"></script>
<script type="text/javascript" src="static/codemirror/mode/python.js"></script>



<style type="text/css">

      .CodeMirror-scroll {
        height: auto; 
        width: 100%;
      }

      .CodeMirror {
        border: 1px solid #eee;
        overflow-x: auto;
        overflow-y: auto; 
      }

      .CodeMirror-focused {
	  border: 1px solid #99f; 
          background-color: #fffff0;    
          max-height:100em;
      }

      .sagews-cell {
      }

      .sagews-stdin {

      }

      .sagews-stdin-scroll {
	max-height:10em;
      }

      .sagews-stderr {
        background-color:#faa;
        font-weight:bold;
        max-height:10em;
      }

      .sagews-stdout {
        background-color:#fafafa;
	max-height:10em; 
      }

      .sagews-footer {
        height:20em;
      }

      .sagews-cells {
         padding:1em;
      }

      .wrap {  /* see http://www.longren.org/wrapping-text-inside-pre-tags/ */
        white-space: pre-wrap; /* css-3 */
        white-space: -moz-pre-wrap !important; /* Mozilla, since 1999 */
        white-space: -pre-wrap; /* Opera 4-6 */
        white-space: -o-pre-wrap; /* Opera 7 */
        word-wrap: break-word; /* Internet Explorer 5.5+ */
       }
</style>

<script type="text/javascript" src="static/backend.js"></script>
<script type="text/javascript">

function walltime() { return (new Date()).getTime(); }

$(function() {

/*    $('body').keydown(function(event) { 
	if (event.which == 13 && event.shiftKey) {
	    execute_code_cell('#cell-0');
	    return false;
	} else if (event.which == 67 && event.ctrlKey) {
	    sigint();
	    return false;
	}
    });
*/


    // TODO: vargs
    function call_ifdef(selector, name, a1, a2) {
        var obj = $(selector);
        var f = obj.data(name);
        if (typeof f === 'undefined') return;
        if (typeof a2 === 'undefined') { f(a1); return; }
        if (typeof a1 === 'undefined') { f(); return; }
        f(a1,a2);
    }

    var options = {
	set:function(selector, value) { call_ifdef(selector, 'set', value); },
        mesg:function(selector, value) { call_ifdef(selector, 'mesg', value); },
 	stdout:function(selector, value, clear) { call_ifdef(selector, 'stdout', value, clear); },
	stderr:function(selector, value, clear) { call_ifdef(selector, 'stderr', value, clear); },
        start:function(selector) { call_ifdef(selector, 'start'); },
	done:function(selector) { call_ifdef(selector, 'done'); }
    }

    var socket = sagews_backend.socket('http://' + window.location.host, options);

    function update_status() {	
	var cmd = 'print("Memory: %sMB    Variables: %s"%(int(sage.all.get_memory_usage()), ", ".join(sorted(sage.all.show_identifiers()))))';
	socket.execute_blocking(cmd,
		function (mesg) { $('#status')[0].innerHTML = mesg.stdout; });
    }

    var start_time = walltime();
    update_status();

   $('#status').css({'borderWidth':'2px', 'borderStyle':'solid', 'borderColor':'grey',
                     'padding':'5px'})

    function trim_cm(cm) {
	var val = cm.getValue();
	if (val[val.length-1] === '\n') {
	    cm.setValue(val.slice(0,val.length-1));
	}
    }

    function SageCell(id, options) {
	var opts = $.extend({
	    stdin:'', 
	    stdout:'', 
	    stderr:'', 
	    html:'',
	    max_output:100000,
	}, options||{});
        var cell = $('<div id="' + id + '" class="sagews-cell"></div>')[0];
        var stdin = CodeMirror(cell, {
	                 value:opts.stdin,
                         lineNumbers: false, 
                         indentUnit: 4, 
                         matchBrackets:true,
                         lineWrapping:true, 
	                 autoClearEmptyLines: true,
                         gutter: true,
                         extraKeys:{
			     'Enter': function(cm) { execute(); },
			     'Shift-Enter': function(cm) { cm.replaceRange('\n',stdin.getCursor()); },
			     'Up':function(cm) { up(); },
			     'Down':function(cm) { down(); }
			 }
                    });

	$(stdin.getWrapperElement()).addClass('sagews-stdin'); 
        $(stdin.getScrollerElement()).addClass('sagews-stdin-scroll');

        stdin.setMarker(0, 'sage: ');

        var stdout = CodeMirror(cell, {
	    value:opts.stdout, lineWrapping:true, readOnly:true})
	var stderr = CodeMirror(cell, {
	    value:opts.stderr, lineWrapping:true, readOnly:true});
	var html = $('<div></div>').append(html)[0];

	// Stylize stdout and stderr
	var stdout_elt = $(stdout.getWrapperElement());
	var stderr_elt = $(stderr.getWrapperElement());
	if (opts.stdout === '') { stdout_elt.hide(); }
	if (opts.stderr === '') { stderr_elt.hide(); } 
	stdout_elt.addClass('sagews-stdout');
	stderr_elt.addClass('sagews-stderr');

	var wcell = $(cell);
        wcell.data({'streams':{'stdin':stdin},
                    'focus':function(line, ch) { 
	               stdin.focus(); 
                       if (typeof line === "undefined") { return; }
	               if (line<0) { line += stdin.lineCount(); }
	               stdin.setCursor(line, ch); 
	            },
                    'refresh':function() { stdin.refresh(); stdout.refresh(); stderr.refresh(); },
		    'set':    function(value) { stdin.setValue(value); },
		    'start':  function() { wcell.data('start_time', walltime()); },
		    'mesg':   function(value) { 
			if (value.type === 'javascript') {eval(value.value);}
		    },
		    'stdout': function(value, clear) {
			if (clear) {
			    if (value) { stdout_elt.show(); }
			    stdout.setValue(truncate(value));
			} else {
			    stdout.setValue(truncate(stdout.getValue() + value));  // TODO
			}
		    },
		    'stderr': function(value, clear) {
			if (clear) {
			    if (value) { stderr_elt.show(); }
			    stderr.setValue(truncate(value));
			} else {
			    stderr.setValue(truncate(stderr.getValue() + value));  // TODO
			}
		    },
		    'done':   function () { 
			var s = (walltime() - wcell.data('start_time')) + ' ms';
			$('#time')[0].innerHTML = s;
			trim_cm(stdout); trim_cm(stderr);
			if (stdout.getValue() === '') { stdout_elt.hide(); }
			if (stderr.getValue() === '') { stderr_elt.hide(); } 
			update_status();
		    }
		   });

	function truncate(s) {
	    if (s.length < opts.max_output) {
		return s;
	    } else {
		/* TODO: at this point, should maybe send interrupt or at least cancel output being sent -- maybe this should be entirely backend side*/
		return s.slice(0, opts.max_output) + ' (output truncated) ';
	    }
	}

	function execute() { 
	    var val = stdin.getValue();
	    socket.set('#'+id, val);
	    socket.execute('#'+id, val, true); 
	    var next = wcell.next();
	    if (next.length === 0) { next = $(appendSageCell('#cells')); }
	    next.data('focus')(0,0);
	}
	
	function up() {
	    var coords = stdin.getCursor();
	    if (coords.line >= 1) {
		stdin.setCursor(coords.line - 1, coords.ch);
	    } else {
		var f = wcell.prev().data('focus'); 
		if (f) { f(-1, coords.ch); } 
	    }
	}

        function down() {
	    var coords = stdin.getCursor();
	    if (coords.line < stdin.lineCount() - 1) {
		stdin.setCursor(coords.line + 1, coords.ch);
	    } else {
		var f = wcell.next().data('focus')
		if (f) { f(0, coords.ch);  } 
	    }

        }
	return cell;
    }

    var cell_number = -1;
    function next_cell_number() {
	cell_number += 1;
	return cell_number;
    }
    function appendSageCell(selector, options) {
	var id = 'cell-' + next_cell_number();
	if ($('#'+id).length != 0) {
	    alert("trying to create a cell with the id " + id + " that already exists will cause horrible confusion!");
	}
	var cell = SageCell(id, options);	
	$(selector).append(cell);
	$(cell).data('refresh')();
	return cell;
    }

    $(appendSageCell('#cells')).data('focus')();

    function session_name() {
	return $('#session-name').val();
    }
    $('#save-session').click(
	function() { 
	    socket.execute('#save-session','save_session("' + session_name() + '")'); 
	}).data('done', function () { /* TODO: visual feedback */ })

    $('#load-session').click(
	function() { 
	    socket.execute('#load-session','reset(); load_session("' + session_name() + '")'); 
	}).data('done', function () { /* TODO: visual feedback */  update_status(); })

    $('#reset-session').click(
	function() { 
	    socket.execute('#reset-session','reset()'); 
	}).data('done', function () { /* TODO: visual feedback */ update_status(); })



    $('#cells').sortable({ opacity: 0.6, delay:1000});


})</script>


<body>
<pre><div id="status" class="wrap">status line</div></pre>
Session: <input id="session-name" value="sagews"> <button id="save-session">save</button><button id="load-session">load</button><button id="reset-session">reset</button>
&nbsp;&nbsp;&nbsp;&nbsp;
Time: <span id="time">0 ms</span>
<br>
<!--<input id="preparse" type="checkbox" checked="true" /> preparse
<button id="execute-0">Execute (shift+enter)</button>
-->
<hr>

<div>
<h1>Sage Command Line</h1>
<div id="cells" class="sagews-cells">
</div>
</div>

<div id="footer" class="sagews-footer"></div>



</body>
</html>



<!--

for i in range(1000):
    sleep(.005)
    sagews.javascript('$("#status").css({"borderWidth":"%spx"})'%(20*float(sin(.1*i))))

-->
