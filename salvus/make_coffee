#!/usr/bin/env bash

set -e

############################################################
# This script is responsible for creating all autogenerated
# .js files from coffee scripts.
############################################################
echo "Rebuilding all CoffeeScript modules..."
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

###########
# Backend server code:
###########
coffee -o node_modules -c *.coffee

###########
# Code shared between backend servers and web browser clients
###########
# do this in the background
browserify -v --exports=require,connect node_modules/client_browser.js -o static/salvus.js && \
      uglifyjs2 static/salvus.js -o static/salvus.min.js && \
      coffee -b -o page/temp page/*.coffee && \
      gen_page && \
      uglifyjs2 static/index.js -o static/index.min.js 

cp node_modules/message.js  static/salvus/ 
coffee -o static/salvus/ -c static/salvus/salvus.coffee 
