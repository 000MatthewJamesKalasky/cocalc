#!/usr/bin/env bash

. salvus-env

set -e

############################################################
# This script is responsible for creating all autogenerated
# .js files from coffee scripts.
############################################################
echo "Rebuilding all CoffeeScript modules..."

# Change to the directory containing this file.
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"


###########
# Backend server code:
###########
./scripts/make_coffee

###########
# Code shared between backend servers and web browser clients
###########
time browserify --exports=require,connect node_modules/client_browser.js -o static/salvus.js && \
      time uglifyjs2 static/salvus.js -o static/salvus.min.js && \
      cd page &&
      time ../scripts/make_coffee temp &&
      cd .. &&
      time gen_page && \
      time uglifyjs2 static/index.js -o static/index.min.js

ls -lh static/salvus.js

cp node_modules/message.js  static/salvus/
