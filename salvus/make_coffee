#!/usr/bin/env bash

. salvus-env

set -e

############################################################
# This script is responsible for creating all autogenerated
# .js files from coffee scripts.
############################################################
echo "Rebuilding all CoffeeScript modules..."
cd "$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

###########
# Backend server code:
###########
time coffee -o node_modules -c *.coffee

###########
# Code shared between backend servers and web browser clients
###########
time browserify --exports=require,connect node_modules/client_browser.js -o static/salvus.js && \
      time uglifyjs2 static/salvus.js -o static/salvus.min.js && \
      time coffee -b -o page/temp page/*.coffee && \
      time gen_page && \
      time uglifyjs2 static/index.js -o static/index.min.js 

ls -lh static/salvus.js

cp node_modules/message.js  static/salvus/ 
