// Generated by CoffeeScript 1.4.0

/*
# coffee -w -c index.coffee
*/


(function() {
  var uuid;

  uuid = function() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        var r = Math.random()*16|0, v = c == 'x' ? r : (r&0x3|0x8);
        return v.toString(16);
    });;
  };

  $(function() {
    var active_cell, execute_code, page, worksheet;
    active_cell = void 0;
    $.fn.extend({
      salvus_worksheet: function(opts) {
        return this.each(function() {
          var worksheet;
          worksheet = $(".salvus-templates").find(".salvus-worksheet").clone();
          $(this).append(worksheet);
          worksheet.append_salvus_cell();
          worksheet.append_salvus_cell();
          return worksheet.append_salvus_cell();
        });
      },
      append_salvus_cell: function(opts) {
        return this.each(function() {
          var cell, id;
          cell = $(".salvus-templates").find(".salvus-cell").clone().data("worksheet", $(this));
          id = uuid();
          cell.attr('id', id);
          cell.find(".salvus-cell-input").data("cell", cell).focus().click(function(e) {
            return active_cell = $(this).data('cell');
          });
          $(this).append(cell);
          return active_cell = cell;
        });
      }
    });
    $(document).keydown(function(e) {
      if (e.which === 13 && !e.shiftKey) {
        execute_code();
        return false;
      }
    });
    execute_code = function() {
      var cell, input, input_text, next, output, output_text;
      cell = active_cell;
      console.log('execute_code!', cell);
      input = cell.find(".salvus-cell-input");
      input_text = input.text();
      console.log(input_text);
      output = cell.find(".salvus-cell-output");
      output_text = eval(input_text);
      worksheet.attr('contenteditable', false);
      output.text(output_text);
      worksheet.attr('contenteditable', true);
      next = cell.next();
      if (next.length === 0) {
        next = cell.data("worksheet").append_salvus_cell();
      }
      next.find(".salvus-cell-input").focus();
      active_cell = next;
      return false;
    };
    page = $("#page");
    return worksheet = page.salvus_worksheet();
  });

}).call(this);
