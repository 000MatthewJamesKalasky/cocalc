#!/usr/bin/env python

import os, sys,time

os.chdir(os.environ['HOME'])

def cmd(s):
    print s
    if os.system(". $HOME/.sagemathcloud/sagemathcloud-env && " + s):
       sys.exit(1)

cmd("cd $HOME/.sagemathcloud && ./make_coffee")

cmd("local_hub start")

# we redirect to /dev/null to detach file descripts so remote ssh terminates without waiting for these. 
cmd("console_server start  </dev/null >/dev/null 2>&1 &")
cmd("sage_server    start  </dev/null >/dev/null 2>&1 &")

# wait until "data/local_hub.port" gets created (up to 15 seconds)
i=0
while not os.path.exists(".sagemathcloud/data/local_hub.port"):
    time.sleep(0.1)
    i += 1
    print i
    if i >= 150:
        sys.stderr.write("Error allocating network port\n")
        sys.exit(1)
