#!/usr/bin/env python

from os import chdir, environ as env, path, popen, system
from sys import exit

if 'MAKE' in env:
    # Just in case somebody has "make -j24" for sage, which breaks the build of node.js.
    del os.environ['MAKE']

P = path.join(env['HOME'], '.sagemathcloud')
env['PATH'] = "%s:%s/node_modules/.bin/:%s/data/local/bin:%s"%(P, P, P, env['PATH'])

chdir(P)

build_node = True
try:
    node_version = popen('node --version').read()[1:]
    # output looks like this: '0.8.14\n'
    if node_version >= '0.8':
        build_node = False
except:
    pass


if build_node:
    if system('./build.py --build_node'):
        print "FAILED to build node..."
        exit(1)
    shutil.rmtree('data/build')   # clear up 130MB+ wasted space used to build node

# Install all the modules we need for the local hub.
# TODO -- under what conditions should we do this?
if system("./install_npm_modules"):
    print "Failed to install all modules"
    exit(1)

# Build coffeescript to javascript
system("./make_coffee")
