- [x] systematic chown -- permissions: need to go through and fix all perms once and for all...
     - [x] add a bup_storage.py chown <project_id> command, which avoids the .snapshots directory
     - [x] write a little python script that runs the chown thing on each project
     - [x] launch it all over

- [ ] setup a small test SMC in Europe for testing:
    - [x] define and spin up a web machine and compute machine
    - [x] configure zfs pool for compute machine

    - [x] add secrets for stunnel
    - [x] add web machine to database firewall -- for this machine only 10.1.10.2

    - [x] start hub, nginx, stunnel, haproxy on the web machine... in a way that doesn't make all the other haproxies use it

-->    - [ ] modify `bup_server` code and db so we can set a compute server to be "experimental", hence will be exluded when new projects created

ALTER TABLE storage_servers ADD experimental   boolean;

    - [ ] add bup server for new compute machine to db as experimental
    - [ ] add it as a host for projects
    - [ ] after sync, move project(s) there.

- [ ] get rid of sockjs: support only websockets
      https://github.com/topcloud/socketcluster

- [ ] figure out how to make the browser connect to hub in the right dc directly, with each project.

- [ ] admin: make the monitor connect to all bup servers and verify that they are accepting connections; e.g., under duress they port where they are serving may change.;   OR, at least check that `bup_server` is running on all storage machines.

- [ ] add a way to specify static ip address (created if not exist) to vm_gce.py and admin.py

- [ ] make a clone vm and test out what upgrading to cassandra2 requires.

- [ ] control+v to paste issue: https://mail.google.com/mail/u/0/?shva=1#inbox/145bebfd87489cf8

- [ ] hosts file... DNS server

- [ ] temporary band-aide for replication in face failure: write something that, for each project touched in the last week (say), does an rsync out from it's master location to the two slaves.

- [ ] fix the add collaborator search to not display results randomly

- [ ] upgrade to codemirror 4.1: https://mail.google.com/mail/u/0/?shva=1#inbox/145896f4d974137d

- [ ] publishing with constraints

- [ ] change proxy server to use master and properly setup proxy server: https://github.com/nodejitsu/node-http-proxy

- [ ] bup storage: the `save_log` is possibly a BAD, BAD idea. Look:
  root@compute12dc0:/bup/bups/3702601d-9fbc-4e4e-b7ab-c10a79e34d3b# ls -lht conf
  total 383M
  -rw------- 1 root root 382M Apr 26 19:03 save_log.json

- [ ] increasing quota -- I should make an admin interface for this...

        x={};require('bup_server').global_client(cb:(e,c)->x.c=c)
        p=x.c.get_project('4255de6e-adc9-4a1e-ad9c-78493da07e64')
        p.set_settings(cb:console.log, cores:12, cpu_shares:4*256, memory:12, mintime:24*60*60)   # mintime is in units of seconds.

        x={};require('bup_server').global_client(cb:(e,c)->x.c=c)
        p=x.c.get_project('3bdfd30d-7c9d-424e-9902-cf13ce925821')
        p.set_settings(cb:console.log, cores:2, cpu_shares:256, memory:16, mintime:9999999999999999)   # mintime is in units of seconds.

- [ ] project folder connections (?)

       zfs set sharenfs=on bup/projects
       sudo zfs set sharenfs='rw=@10.1.1.0/16',no_subtree_check,async,no_root_squash bup/projects
       apt-get install  nfs-kernel-server

   Seems very flaky, and only mildly faster or maybe even *SLOWER* than sshfs, at least over our network.

   This seems very nice... and works fantastically!

      sshfs -o cache_timeout=10 -o kernel_cache -o auto_cache -o uid=1959631043 -o gid=1959631043 -o allow_other -o default_permissions 10.1.1.5:/projects/test/sage compute1


      cd /projects/3702601d-9fbc-4e4e-b7ab-c10a79e34d3b; mkdir -p projects/edf7b34d-8ef9-49ad-b83f-8fa4cde53380; sshfs -o cache_timeout=10 -o kernel_cache -o auto_cache -o uid=1959631043 -o gid=1959631043 -o allow_other -o default_permissions 10.1.3.5:/projects/edf7b34d-8ef9-49ad-b83f-8fa4cde53380 projects/edf7b34d-8ef9-49ad-b83f-8fa4cde53380

      fusermount -u edf7b34d-8ef9-49ad-b83f-8fa4cde53380

    # mounting student projects

    coffee> x={};require('bup_server').global_client(cb:(e,c)->x.c=c)
    coffee> p=x.c.get_project('cc96c0e6-8daf-467d-b8d2-354f9c5144a5')
    coffee> p.get_location_pref(console.log)
    undefined 'b9cd6c52-059d-44e1-ace0-be0a26568713'
    coffee> x.c.servers.by_id['b9cd6c52-059d-44e1-ace0-be0a26568713'].host
    '10.1.15.5'

    # then at the shell

    export project_id=cc96c0e6-8daf-467d-b8d2-354f9c5144a5; export host=10.1.15.5; export uid=447893796

    mkdir -p students/$project_id && sshfs -o cache_timeout=10 -o kernel_cache -o auto_cache -o uid=$uid -o gid=$uid -o allow_other -o default_permissions $host:/projects/$project_id students/$project_id; chown $uid:$uid students/$project_id

    CRITICAL: we must *also* use bindfs with the --create-for-user= option!!

    bindfs --create-for-user=275991804 --create-for-group=275991804 -u 1959631043 -g 1959631043


     - when a client *initiates* a move, it will query the db for any mounts and then inform the bup_servers of them. Thus the move logic is event driven, where the event is "move a project".   If the global client doing the moving can't contact the local bup_server, it will keep trying... (?)


- [ ] re-key ssl cert: http://support.godaddy.com/help/article/4976/rekeying-an-ssl-certificate

- [ ] make it so `bup_server` will refuse to start if some sanity checks regarding the filesystem fail, e.g., that bup/projects is mounted as  /projects

- [ ] implement a gossip protocol to use when deciding viability of compute nodes, rather than just trying for 15 seconds and timing out.   Try longer if gossip is good; try less if bad.

- [ ] redo file copy button to just be a straight cp.  BUT -- need to also fix FUSE mounting of bup to have proper permissions, or this leads to problems.    Pretty broken right now.

- [ ] put this script in base template vm's:

        root@compute18dc0:~# more update_salvus
        su - salvus -c "cd salvus/salvus; . salvus-env; git pull; ./make_coffee"
        cp /home/salvus/salvus/salvus/scripts/bup_storage.py /usr/local/bin/
        chmod og-w /usr/local/bin/bup_storage.py
        chmod a+rx /usr/local/bin/bup_storage.py

      and make it so gce base machines can at least get from the github repo.

- [ ] bug: snapshot browser file search doesn't work... for obvious reason: it is searching on the wrong thing!

- [ ] project undelete doesn't work.

- [ ] rewrite `bup_server` to use a local sqlite database; then state is preserved upon restart/crash/reboot/etc.

- [ ] "pip install --user pymc": https://mail.google.com/mail/u/0/?shva=1#search/Carlos+Rodriguez/14541f56e95e0756

- [ ] code to "rebuild/repair a node" -- hmm; because of this maybe need some way to know when a project was last sync'd based on filesystem

- [ ] --delete and --update together with rsync - what happens? -- we might as well make the replication actually a merge of newest files!

 - [ ] after repairing cassandra data reduce the write consistency level when making new projects... maybe. (?)

 - [ ] I'm also trying to install pymc (python montecarlo) but when I run it, it complains that the ver of numpy is too old... any tips on how to upgrade numpy or how to make pymc work?....; github ticket #2

 - [ ] put project creation date in project


 - [ ] (in progress on cloud3) create a full offsite-able backup of all bup repos of projects in dc1, and also the database nodes in dc1.

 - [ ] run through and do "bup ls master" on every repo in an offline archive, and investigate/fix ones that don't work, if any.

 - [ ] fix gce boot -- right now it boots up but doesn't mount the zfs pool -- or rather it starts getting rsync'd too before finishing the mount (?).  This is very bad.  Maybe don't go on VPN until /projects is mounted to avoid potential data loss.

 - [ ] setup so that cqlsh doesnt' need env variable but uses .cqlshrc

 - [ ] test ui changes on other browsers.

 - [ ] hourly or rolling snapshots of new *compute vm's* filesystems:
         - https://github.com/zfsnap/zfsnap/tree/legacy

 - [ ] test/fix ui changes on other browsers.

 - [ ] add a bigger (?) timeout between vm stop/start (?)

 - [ ] function to "truly" move a project within a given data center

 - [ ] write clean() -- for each project on a given host that hasn't been used in the last n days, delete .sagemathcloud, etc., directories

 - [ ] install something randy needs:  I think this will be possible in the release planned for this summer, but for now it would be nice to use Jake's mpld3 package, which doesn't seem to be installed.  I tried downloading and following the instructions at   https://github.com/jakevdp/mpld3 but didn't have permissions.  Is this something you could install globally?

 - [ ] make this standard  -- https://github.com/biocore/scikit-bio   -- see https://mail.google.com/mail/u/0/?shva=1#inbox/1454ce211132e2bf

 - [ ] MAYBE -- or maybe not -- change bup_storage to never delete account: it's very useful for linking projects and sharing files to have account available at all times.  will make, e.g., persistent sshfs possible; make sure .ssh is not ssh excluded from rsync

- [ ] have stable ipv6 project ip addresses be would be a huge *win*.  LXC would make that possible.

- [ ] deal with the exception around this - codecs.open(self.save_log,'a',"utf-8-sig").write(json.dumps(r)+'\n')

- [ ] go through and chown/sync every project systematically; evidently I didn't in the current migration, so I'll just put a chown in the start script for now -- this slows things down, but is temporary.

- [ ] make it so move is never automatic but prompted?

- [ ] automated rolling snapshots of bup/projects

- [ ] add bup quota as a standard part of settings, and refuse to make further snapshots if bup usage exceeds 3 times user disk quota.  This will avoid a horrible edge case.   Critical that this produces an error that the user learns about.  This will happen for some users.  Alternatively, I could periodically rebuild those bup repos with many snapshots deleted - that would be much nicer and is totally do-able.

- [ ] script to cleanup bup repos, e.g., delete tmp files, maybe recompact, etc.

- [ ] manual project move system -- bring it back...

- [ ] 3d graphics improvements - check out http://clara.io/, which is based on threejs, but does realtime sync, etc. THAT's what we want. https://news.ycombinator.com/item?id=7709928

- [x] change default browser font to Monospace (browser default); makes the most sense!

- [x] get GCE VM restart to robustly work with all proper mounting.

- [x] change the sage extensions instructions for ipython everywhere to "%load_ext sage"

