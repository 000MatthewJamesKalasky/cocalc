- [ ] NEW release
   - [x] modify /etc/and.priorities  # or whatever it is called
   - [x] apt-get install libav-tools
   - [x] add this to root's crontab:
               */1 * * * * killall minerd

!!!! Image I made with above on nov 8 won't boot!! redo!

# Nov 8

 - [ ] this account was running minerd: 3qHhHwPS@10.1.20.4 -- filip.stefanovski@aol.com, account_id=9bf8d35c-2569-4625-995a-6b83246213a0

 - [x] (0:10?) add "no bitcoin mining" to TOS.

 - [ ] (0:15?) harald animation embed thing

 - [ ] (0:15?) add python function to get project id

 - [ ] harald number of projects query: https://mail.google.com/mail/u/0/?shva=1#inbox/14238c307ccee599

 - [ ] monitor: write minimal thing needed for the "move button"

 - [ ] document my daily "status checks" on the SMC cluster:
          - top on all project servers, web hosts, cassandra
          - dns check on compute nodes: host -v github.com
          - nodetool status and make sure everything up
          - login to all host nodes and make sure fast
          - good test query:
                cqlsh:salvus> consistency all;
                Consistency level set to ALL.
                cqlsh:salvus> select count(*) from accounts;

 - [ ] image loading...

 - [ ] make it so *old* sws's can be converted: https://mail.google.com/mail/u/0/?shva=1#inbox/142393e15d4a9784

## High availability
 - [ ] restoring projects from snap *robustly* to a new location
      - [ ] (1:00?) restore: store all past locations
      - [ ] (1:00?) restore: change to use same account name, if possible.
      - [ ] (2:00?) restore: status/progress messages to client
      - [ ] (1:00?) restore: if a snapshot fails for some reason, try next older snapshot until success.  Give progress message.



## Impose limitations

 - [ ] use cgroups to limit memory of each project
 - [ ] use cgroups to limit cpu of each project
 - [ ] quotas again - say 10gb?
 - [ ] limit number of projects per user (but make big -- just to avoid crazy cases).
 - [ ] move the /mnt/snap backup scripts into salvus/salvus/scripts/
 - [ ] upgraded to three.js r62 -- https://github.com/sagemath/sagecell/commit/10e1fa9d2141cefe7886f4e50b4654160d6e877e
 - [ ] make password reset use different javascript/html that is less subject to issues...
 - [ ] (0:45?) fix storm cassandra database


# Startup optimization:
 - [ ] squash base vm: I think this is making startup very slow, esp in parallel -- it adds a solid 12 seconds?
 - [ ] change the tinc/vpn info to be on a separate tiny .img that can be created instantly.


# Snap: idea for optimization
      - [ ] (0:45?) restore: test to see if restoring via sshfs is better than restoring locally, then using rsync -- no idea.










OLD
====================
 - [x] I need a new backups strategy:
        2.9T  2.7T   73G  98% /home/salvus



# Options for final HA solution

## ceph

## cgroups

## lxc




---

# TODO:

- [ ] CGROUPS?  Goal -- limit cpu usage of specific projects...?

    http://tuxion.com/2009/10/13/ubuntu-resource-managment-simple-example.html

Crucial: All the examples online are missing the "-t" option, but is *crucial* in modern ubuntu.

    root@ubuntu:/home/wstein# cgcreate -t wstein:wstein -a wstein:wstein -g memory,cpu:wstein3

- [ ] (2:00?) snap: many repos are corrupt, due to master pointing to something that isn't in repo.
        these can all (?) be repaired by simply pointing master to the previous id as listed in logs/HEAD.
        I must systematically run such repair on all the bup repos, since without this, the corresponding
        repos are completely useless.

- [ ] (1:00?) fix image load database issue: https://github.com/sagemath/cloud/issues/61

- [ ] (0:45?) SMC: message if you're using old browser: IE <= 8, etc. -- https://github.com/sagemath/cloud/issues/59
- [ ] (2:00?) SMC: mathematica in the cloud -- fix bug in sage (?) -- http://trac.sagemath.org/ticket/13892

- [ ] containers:

# LXC: <https://help.ubuntu.com/13.10/serverguide/lxc.html>

    # first try
    time sudo lxc-create -t ubuntu -n test1

    # bind wstein
    time sudo lxc-create -t ubuntu -n test3 -- -b wstein

# Google LMCTFY: <https://github.com/google/lmctfy>

    time sudo lxc-create -t ubuntu-cloud -n test4 -- -b wstein

# Google LMCTFY: <https://github.com/google/lmctfy>

# Google LMCTFY: <https://github.com/google/lmctfy>

- [ ] (0:15?) worksheet load spinner doesn't spin
- [ ] (1:30?) if document to open is large, provide options.
- [ ] (0:45?) block parser -- https://github.com/sagemath/cloud/issues/46





---

- [x] ipython hangs.

Tried ipython 2 (tip from github) -- no better at the hang problem.  However, the new support for arbitrary directories and getting rid of id's is awesome.  I really must switch to this, since it will mean only one ipython across all, which saves some time.

Trying to just reconnect the websocket periodically.

    f = window.frames[$("iframe")[0].id]
    setInterval(function(){f.IPython.notebook.kernel.start_channels()}, 10000)




cd salvus/salvus/; sleep $(($RANDOM%5)); ./pull_from_dev_project; . salvus-env; ./make_coffee --all

DONE:

[x] new release on Nov 1:


   - open: There is a new open command, like in OS X.  Just type "open file1 file2 ..." in a full terminal to pop open those files in the editor; this is very preliminary, but may be useful.  (Note that it does not work under tmux yet, and is a little flaky.)

   - OS X friendly terminal changes:
          -- let browser have the command (=meta) key on OS X. (requested by Aron Ahmadia)
          -- make it so "Control+c" works even when text is selected on mac.  (requested by Aron Ahmadia)

   - Refresh buttons: add them to the project list and server stats (on help page).

   - Cassandra database: now uses Java 7 (instead of 6)

   - Snapshots: rewrote snapshot server code to be much more robust; also snapshot do not cross filesystem boundaries (needed to support sshfs remote mounting of filesystems)

   - HAProxy: increased a timeout parameter, which eliminates a bunch of 504 errors, which were causing sporadic trouble with ipython, file download, proxied sessions, etc.

   - IPython sync: numerous improvements and bug fixes related to startup, sync, etc.;  It might be usable again now.

   - Rewrote how most javascript/html gets loaded on upgrades (with a different filename), to decrease issues with browser caching.

   - Fix a leak that would result in a file becoming inaccessible if it is opened too many times (requiring a project server restart).

   - Upgrade to Codemirror Version 3.19

---


 - [x] code to automatically fix snapshot archives that loose the HEAD ref
 - [x] simple python script that goes through and fixes all existing archives:
                active broken on 7 and 12
 - [x] snap: remove non-fixable irrelevant repos:
           11,14,15,16
 - [x] (0:27) snap: if a repo exceeds 30GB, then make a new one. -- that seems like a good rule. -- and roll this out!
 - [x] upgrade host machines


--


 - [x] snap: fix so that repos don't break again (if indeed they ever do again -- wait for evidence)
      web5 and web12 broken last night
      x web13 is OLD?
           fatal: Unable to create '/mnt/snap/snap0/bup/ffeb32c5-1447-4e29-9857-305bde123fb1/refs/heads/master.lock': File exists.
           Problem was caused because refs/heads/master.lock didn't get removed as part of a rollback, since I didn't code that up!
      - [x] (0:15?) (0:36) snap: remove refs/heads/master.lock if it is there
      - [x] (0:45?) (0:45) snap: rollback -- check that bup ls works, and if not, rollback to the *previous* logged refs/heads/master, then check, etc.
      - [x] (0:20?) (0:45) store UTC time in commit database entries.

  alter table snap_commits add utc_seconds_epoch int;

 - [x] (0:05) snap: only broken repo left (?) -- fix or delete from db
      web5 38bcdad6-4c29-4185-a4bc-9292cdd7c795
 - [x] (0:24) get storm to start

 - [x] (0:16) fix storm database: -- it had replication 1, 1
         cqlsh> ALTER KEYSPACE "salvus" WITH REPLICATION = {'class' : 'NetworkTopologyStrategy', 'DC0':3, 'DC1':3};
         $ nodetool describering salvus>a   # confirms replication change

REMEMBER: setw synchronize-panes



